import { EntityCacheMemory } from '#src/entity-cache/memory';
export class EntityCachePromiseService {
    _dao;
    constructor(dao) {
        this._dao = dao ?? new EntityCacheMemory();
    }
    /**
     * Subscribe to entity cache change and retrieve cached value if not undefined
     * @param {ID} id - entity unique identifier
     * @param {EntityCacheCallBack<ENTITY>} callback -
     * @returns {EntityCacheSubscription}
     */
    subscribeToEntityChangeById(id, callback) {
        const idString = id.toString();
        const subscription = this._dao.subscribeById(idString, callback);
        const { entity, needToFetch = false } = this._dao.getById(idString);
        if (entity !== undefined) {
            callback({ entity, id: idString });
        }
        if (needToFetch) {
            this.forceRefresh(id);
        }
        return subscription;
    }
    forceRefresh(id) {
        this._entityAsync(id).then((entity) => {
            return this._dao.set({ entity, id: id.toString() }, this._timeoutOffsetMs);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbWlzZS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VudGl0eS1jYWNoZS9wcm9taXNlLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUF1QixpQkFBaUIsRUFBMkIsTUFBTSwwQkFBMEIsQ0FBQTtBQUUxRyxNQUFNLE9BQWdCLHlCQUF5QjtJQUMzQixJQUFJLENBQTJCO0lBS2xELFlBQXNCLEdBQStCO1FBQ3BELElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxJQUFJLElBQUksaUJBQWlCLEVBQVUsQ0FBQTtJQUNuRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCwyQkFBMkIsQ0FBQyxFQUFNLEVBQUUsUUFBcUM7UUFDeEUsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQzlCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUNoRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFdBQVcsR0FBRyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUNuRSxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUMxQixRQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFDbkMsQ0FBQztRQUNELElBQUksV0FBVyxFQUFFLENBQUM7WUFDakIsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUN0QixDQUFDO1FBRUQsT0FBTyxZQUFZLENBQUE7SUFDcEIsQ0FBQztJQUVELFlBQVksQ0FBQyxFQUFNO1FBQ2xCLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUE7UUFDM0UsQ0FBQyxDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHlDYWNoZUNhbGxCYWNrLCBFbnRpdHlDYWNoZU1lbW9yeSwgRW50aXR5Q2FjaGVTdWJzY3JpcHRpb24gfSBmcm9tICcjc3JjL2VudGl0eS1jYWNoZS9tZW1vcnknXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFbnRpdHlDYWNoZVByb21pc2VTZXJ2aWNlPEVOVElUWSwgSUQgZXh0ZW5kcyBzdHJpbmcgfCBudW1iZXIgPSBzdHJpbmc+IHtcblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9kYW86IEVudGl0eUNhY2hlTWVtb3J5PEVOVElUWT5cblxuXHRwcm90ZWN0ZWQgYWJzdHJhY3QgcmVhZG9ubHkgX3RpbWVvdXRPZmZzZXRNcz86IG51bWJlclxuXHRwcm90ZWN0ZWQgYWJzdHJhY3QgX2VudGl0eUFzeW5jKGlkOiBJRCk6IFByb21pc2U8RU5USVRZPlxuXG5cdHByb3RlY3RlZCBjb25zdHJ1Y3RvcihkYW8/OiBFbnRpdHlDYWNoZU1lbW9yeTxFTlRJVFk+KSB7XG5cdFx0dGhpcy5fZGFvID0gZGFvID8/IG5ldyBFbnRpdHlDYWNoZU1lbW9yeTxFTlRJVFk+KClcblx0fVxuXG5cdC8qKlxuXHQgKiBTdWJzY3JpYmUgdG8gZW50aXR5IGNhY2hlIGNoYW5nZSBhbmQgcmV0cmlldmUgY2FjaGVkIHZhbHVlIGlmIG5vdCB1bmRlZmluZWRcblx0ICogQHBhcmFtIHtJRH0gaWQgLSBlbnRpdHkgdW5pcXVlIGlkZW50aWZpZXJcblx0ICogQHBhcmFtIHtFbnRpdHlDYWNoZUNhbGxCYWNrPEVOVElUWT59IGNhbGxiYWNrIC1cblx0ICogQHJldHVybnMge0VudGl0eUNhY2hlU3Vic2NyaXB0aW9ufVxuXHQgKi9cblx0c3Vic2NyaWJlVG9FbnRpdHlDaGFuZ2VCeUlkKGlkOiBJRCwgY2FsbGJhY2s6IEVudGl0eUNhY2hlQ2FsbEJhY2s8RU5USVRZPik6IEVudGl0eUNhY2hlU3Vic2NyaXB0aW9uIHtcblx0XHRjb25zdCBpZFN0cmluZyA9IGlkLnRvU3RyaW5nKClcblx0XHRjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9kYW8uc3Vic2NyaWJlQnlJZChpZFN0cmluZywgY2FsbGJhY2spXG5cdFx0Y29uc3QgeyBlbnRpdHksIG5lZWRUb0ZldGNoID0gZmFsc2UgfSA9IHRoaXMuX2Rhby5nZXRCeUlkKGlkU3RyaW5nKVxuXHRcdGlmIChlbnRpdHkgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0Y2FsbGJhY2soeyBlbnRpdHksIGlkOiBpZFN0cmluZyB9KVxuXHRcdH1cblx0XHRpZiAobmVlZFRvRmV0Y2gpIHtcblx0XHRcdHRoaXMuZm9yY2VSZWZyZXNoKGlkKVxuXHRcdH1cblxuXHRcdHJldHVybiBzdWJzY3JpcHRpb25cblx0fVxuXG5cdGZvcmNlUmVmcmVzaChpZDogSUQpOiB2b2lkIHtcblx0XHR0aGlzLl9lbnRpdHlBc3luYyhpZCkudGhlbigoZW50aXR5KSA9PiB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fZGFvLnNldCh7IGVudGl0eSwgaWQ6IGlkLnRvU3RyaW5nKCkgfSwgdGhpcy5fdGltZW91dE9mZnNldE1zKVxuXHRcdH0pXG5cdH1cbn1cbiJdfQ==